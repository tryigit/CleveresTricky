#!/system/bin/sh
# CleveresTricky Security Patch Utility
# Syncs security patch level with TrickyStore/other modules

DATADIR="/data/adb/cleverestricky"
MODDIR="${MODDIR:-/data/adb/modules/cleveres_tricky}"

# Config flags
AUTO_FLAG="$DATADIR/auto_security_patch"
PATCH_FILE="$DATADIR/security_patch.txt"

log() { echo "[SecurityPatch] $1"; }

# Handle enable/disable
case "$1" in
    --enable)
        touch "$AUTO_FLAG"
        log "Auto security patch enabled"
        exit 0
        ;;
    --disable)
        rm -f "$AUTO_FLAG" "$MODDIR/system.prop"
        log "Auto security patch disabled"
        exit 0
        ;;
esac

# Get security patch from spoof_build_vars
get_security_patch() {
    local spoof="$DATADIR/spoof_build_vars"
    if [ -f "$spoof" ]; then
        grep "^SECURITY_PATCH=" "$spoof" | cut -d= -f2
    else
        # Fallback to current month
        date '+%Y-%m-05'
    fi
}

# Parse security_patch.txt format
# Simple: 20241101
# Advanced: system=202411, boot=2024-11-01, vendor=no
parse_patch_config() {
    local file="$1"
    
    if [ ! -f "$file" ]; then
        return 1
    fi
    
    # Check if advanced format
    if grep -q "=" "$file"; then
        SYSTEM_PATCH=$(grep "^system=" "$file" | cut -d= -f2)
        BOOT_PATCH=$(grep "^boot=" "$file" | cut -d= -f2)
        VENDOR_PATCH=$(grep "^vendor=" "$file" | cut -d= -f2)
        ALL_PATCH=$(grep "^all=" "$file" | cut -d= -f2)
        
        # Handle special values
        [ "$SYSTEM_PATCH" = "prop" ] && SYSTEM_PATCH=""
        [ "$BOOT_PATCH" = "no" ] && BOOT_PATCH=""
        [ "$VENDOR_PATCH" = "no" ] && VENDOR_PATCH=""
        
        # Apply 'all' as default
        [ -z "$SYSTEM_PATCH" ] && [ -n "$ALL_PATCH" ] && SYSTEM_PATCH="$ALL_PATCH"
        [ -z "$BOOT_PATCH" ] && [ -n "$ALL_PATCH" ] && BOOT_PATCH="$ALL_PATCH"
        [ -z "$VENDOR_PATCH" ] && [ -n "$ALL_PATCH" ] && VENDOR_PATCH="$ALL_PATCH"
    else
        # Simple format - just a date
        local simple=$(grep -v "^#" "$file" | head -n1 | tr -d ' ')
        SYSTEM_PATCH="$simple"
        BOOT_PATCH="$simple"
        VENDOR_PATCH="$simple"
    fi
}

# Write system.prop for prop spoofing
write_system_prop() {
    local output="$MODDIR/system.prop"
    local patch="$1"
    
    if [ -z "$patch" ]; then
        rm -f "$output"
        return
    fi
    
    # Format patch if needed (YYYYMMDD -> YYYY-MM-DD)
    if echo "$patch" | grep -qE '^[0-9]{8}$'; then
        patch=$(echo "$patch" | sed 's/\(....\)\(..\)\(..\)/\1-\2-\3/')
    fi
    
    cat > "$output" << EOF
# Auto-generated by CleveresTricky
ro.build.version.security_patch=$patch
ro.vendor.build.security_patch=$patch
EOF
    
    log "system.prop written with patch: $patch"
}

# Sync with TrickyStore if installed
sync_trickystore() {
    local ts_mod="/data/adb/modules/tricky_store"
    
    if [ ! -d "$ts_mod" ]; then
        return 0
    fi
    
    log "Syncing with TrickyStore..."
    
    # Detect TrickyStore variant
    local config_file
    if grep -q "James" "$ts_mod/module.prop" 2>/dev/null; then
        config_file="/data/adb/tricky_store/devconfig.toml"
    else
        config_file="/data/adb/tricky_store/security_patch.txt"
    fi
    
    local patch=$(get_security_patch)
    local short_patch=$(echo "$patch" | tr -d '-')
    
    if [ "$config_file" = "/data/adb/tricky_store/security_patch.txt" ]; then
        # Standard format
        mkdir -p "$(dirname "$config_file")"
        cat > "$config_file" << EOF
system=$short_patch
boot=$patch
vendor=$patch
EOF
    elif [ -f "$config_file" ]; then
        # TOML format (James fork)
        if grep -q "^securityPatch" "$config_file"; then
            sed -i "s/^securityPatch.*/securityPatch = \"$patch\"/" "$config_file"
        else
            echo "securityPatch = \"$patch\"" >> "$config_file"
        fi
    fi
    
    log "TrickyStore synced: $patch"
}

# Main
main() {
    log "Security Patch Utility"
    
    # Check if auto mode enabled
    if [ ! -f "$AUTO_FLAG" ] && [ "$1" != "--force" ]; then
        log "Auto mode disabled. Use --enable to activate."
        exit 0
    fi
    
    # Parse config
    if [ -f "$PATCH_FILE" ]; then
        parse_patch_config "$PATCH_FILE"
    else
        local auto_patch=$(get_security_patch)
        SYSTEM_PATCH="$auto_patch"
        BOOT_PATCH="$auto_patch"
        VENDOR_PATCH="$auto_patch"
    fi
    
    log "System: $SYSTEM_PATCH"
    log "Boot: $BOOT_PATCH"
    log "Vendor: $VENDOR_PATCH"
    
    # Write props
    write_system_prop "$SYSTEM_PATCH"
    
    # Sync with TrickyStore
    sync_trickystore
    
    log "Done!"
}

main "$@"
